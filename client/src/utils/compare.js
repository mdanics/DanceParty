var M = 10;

const pose1 = {
  "pose": {
    "score": 0.6108914972556865,
    "keypoints": [
      {
        "score": 0.9977878928184509,
        "part": "nose",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9839597344398499,
        "part": "leftEye",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9972540736198425,
        "part": "rightEye",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.3806294798851013,
        "part": "leftEar",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.8544093370437622,
        "part": "rightEar",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9445289373397827,
        "part": "leftShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.978367805480957,
        "part": "rightShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9185067415237427,
        "part": "leftElbow",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9255606532096863,
        "part": "rightElbow",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.6114972829818726,
        "part": "leftWrist",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9429396390914917,
        "part": "rightWrist",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.457353413105011,
        "part": "leftHip",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.33825093507766724,
        "part": "rightHip",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.019189801067113876,
        "part": "leftKnee",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.013536391779780388,
        "part": "rightKnee",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.012062248773872852,
        "part": "leftAnkle",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.00932108610868454,
        "part": "rightAnkle",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ],
    "nose": {
      "x": 0,
      "y": 0,
      "confidence": 0.9977878928184509
    },
    "leftEye": {
      "x": 0,
      "y": 0,
      "confidence": 0.9839597344398499
    },
    "rightEye": {
      "x": 0,
      "y": 0,
      "confidence": 0.9972540736198425
    },
    "leftEar": {
      "x": 0,
      "y": 0,
      "confidence": 0.3806294798851013
    },
    "rightEar": {
      "x": 0,
      "y": 0,
      "confidence": 0.8544093370437622
    },
    "leftShoulder": {
      "x": 0,
      "y": 0,
      "confidence": 0.9445289373397827
    },
    "rightShoulder": {
      "x": 0,
      "y": 0,
      "confidence": 0.978367805480957
    },
    "leftElbow": {
      "x": 0,
      "y": 0,
      "confidence": 0.9185067415237427
    },
    "rightElbow": {
      "x": 0,
      "y": 0,
      "confidence": 0.9255606532096863
    },
    "leftWrist": {
      "x": 0,
      "y": 0,
      "confidence": 0.6114972829818726
    },
    "rightWrist": {
      "x": 0,
      "y": 0,
      "confidence": 0.9429396390914917
    },
    "leftHip": {
      "x": 0,
      "y": 0,
      "confidence": 0.457353413105011
    },
    "rightHip": {
      "x": 0,
      "y": 0,
      "confidence": 0.33825093507766724
    },
    "leftKnee": {
      "x": 0,
      "y": 0,
      "confidence": 0.019189801067113876
    },
    "rightKnee": {
      "x": 0,
      "y": 0,
      "confidence": 0.013536391779780388
    },
    "leftAnkle": {
      "x": 0,
      "y": 0,
      "confidence": 0.012062248773872852
    },
    "rightAnkle": {
      "x": 0,
      "y": 0,
      "confidence": 0.00932108610868454
    }
  },
  "skeleton": [
    [
      {
        "score": 0.9185067415237427,
        "part": "leftElbow",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9445289373397827,
        "part": "leftShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ],
    [
      {
        "score": 0.9185067415237427,
        "part": "leftElbow",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.6114972829818726,
        "part": "leftWrist",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ],
    [
      {
        "score": 0.9255606532096863,
        "part": "rightElbow",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.978367805480957,
        "part": "rightShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ],
    [
      {
        "score": 0.9255606532096863,
        "part": "rightElbow",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9429396390914917,
        "part": "rightWrist",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ],
    [
      {
        "score": 0.9445289373397827,
        "part": "leftShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.978367805480957,
        "part": "rightShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ]
  ]
}

const post2 = {
  "pose": {
    "score": 0.6136854393407702,
    "keypoints": [
      {
        "score": 0.9936995506286621,
        "part": "nose",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9672339558601379,
        "part": "leftEye",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9932014346122742,
        "part": "rightEye",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.34845277667045593,
        "part": "leftEar",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.8224761486053467,
        "part": "rightEar",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9370155930519104,
        "part": "leftShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9801183938980103,
        "part": "rightShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9007631540298462,
        "part": "leftElbow",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9178694486618042,
        "part": "rightElbow",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.7146350145339966,
        "part": "leftWrist",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9319605827331543,
        "part": "rightWrist",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.5307576060295105,
        "part": "leftHip",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.33245131373405457,
        "part": "rightHip",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.015726720914244652,
        "part": "leftKnee",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.011165120638906956,
        "part": "rightKnee",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.01937517710030079,
        "part": "leftAnkle",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.015750477090477943,
        "part": "rightAnkle",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ],
    "nose": {
      "x": 0,
      "y": 0,
      "confidence": 0.9936995506286621
    },
    "leftEye": {
      "x": 0,
      "y": 0,
      "confidence": 0.9672339558601379
    },
    "rightEye": {
      "x": 0,
      "y": 0,
      "confidence": 0.9932014346122742
    },
    "leftEar": {
      "x": 0,
      "y": 0,
      "confidence": 0.34845277667045593
    },
    "rightEar": {
      "x": 0,
      "y": 0,
      "confidence": 0.8224761486053467
    },
    "leftShoulder": {
      "x": 0,
      "y": 0,
      "confidence": 0.9370155930519104
    },
    "rightShoulder": {
      "x": 0,
      "y": 0,
      "confidence": 0.9801183938980103
    },
    "leftElbow": {
      "x": 0,
      "y": 0,
      "confidence": 0.9007631540298462
    },
    "rightElbow": {
      "x": 0,
      "y": 0,
      "confidence": 0.9178694486618042
    },
    "leftWrist": {
      "x": 0,
      "y": 0,
      "confidence": 0.7146350145339966
    },
    "rightWrist": {
      "x": 0,
      "y": 0,
      "confidence": 0.9319605827331543
    },
    "leftHip": {
      "x": 0,
      "y": 0,
      "confidence": 0.5307576060295105
    },
    "rightHip": {
      "x": 0,
      "y": 0,
      "confidence": 0.33245131373405457
    },
    "leftKnee": {
      "x": 0,
      "y": 0,
      "confidence": 0.015726720914244652
    },
    "rightKnee": {
      "x": 0,
      "y": 0,
      "confidence": 0.011165120638906956
    },
    "leftAnkle": {
      "x": 0,
      "y": 0,
      "confidence": 0.01937517710030079
    },
    "rightAnkle": {
      "x": 0,
      "y": 0,
      "confidence": 0.015750477090477943
    }
  },
  "skeleton": [
    [
      {
        "score": 0.5307576060295105,
        "part": "leftHip",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9370155930519104,
        "part": "leftShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ],
    [
      {
        "score": 0.9007631540298462,
        "part": "leftElbow",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9370155930519104,
        "part": "leftShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ],
    [
      {
        "score": 0.9007631540298462,
        "part": "leftElbow",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.7146350145339966,
        "part": "leftWrist",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ],
    [
      {
        "score": 0.9178694486618042,
        "part": "rightElbow",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9801183938980103,
        "part": "rightShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ],
    [
      {
        "score": 0.9178694486618042,
        "part": "rightElbow",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9319605827331543,
        "part": "rightWrist",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ],
    [
      {
        "score": 0.9370155930519104,
        "part": "leftShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      },
      {
        "score": 0.9801183938980103,
        "part": "rightShoulder",
        "position": {
          "x": 0,
          "y": 0
        }
      }
    ]
  ]
}

var mp = {'nose': 0, 'leftEye': 1, 'rightEye': 2, 'leftEar': 3, 'rightEar': 4, 'leftShoulder': 5, 'rightShoulder': 6, 'leftElbow': 7, 'rightElbow': 8, 
'leftWrist': 9, 'rightWrist': 10, 'leftHip': 11, 'rightHip': 12, 'leftKnee': 13, 'rightKnee': 14, 'leftAnkle': 15, 'rightAnkle': 16}

function datapts(person, data){
    for (let j = 0; j < person.length; j++){
        data.push([person[j]['position']['x'], person[j]['position']['y']]);
    }
}

function radians_to_degrees(radians)
{
  var pi = Math.PI;
  return radians * (180/pi);
}

var hw = 0.6;
var sw = 0.2;
var lw = 0.2;

function compare(d1, d2, t){
    var v1 = hands(d1[mp['rightShoulder']], d1[mp['rightElbow']], d1[mp['rightWrist']],  d2[mp['rightShoulder']], d2[mp['rightElbow']], d2[mp['rightWrist']], t);
    var v2 = hands(d1[mp['leftShoulder']], d1[mp['leftElbow']], d1[mp['leftWrist']],  d2[mp['leftShoulder']], d2[mp['leftElbow']], d2[mp['leftWrist']], t);
    var v3 = shoulder(d1[mp['leftShoulder']], d1[mp['rightShoulder']], d2[mp['leftShoulder']],  d2[mp['rightShoulder']], t);
    var v4 = leg(d1[mp['leftHip']], d1[mp['leftKnee']], d1[mp['leftAnkle']],  d2[mp['leftHip']], d2[mp['leftKnee']], d2[mp['leftAnkle']], t);
    var v5 = leg(d1[mp['rightHip']], d1[mp['rightKnee']], d1[mp['rightAnkle']],  d2[mp['rightHip']], d2[mp['rightKnee']], d2[mp['rightAnkle']], t);
    return (((v1 + v2) / 4) * hw) + (v3 * sw) + (((v4 + v5) / 4) * lw);
}

function deg(x1, y1, x2, y2){
    var x = x2 - x1;
    var y = y2 - y1;
    
    if (x == 0) {
    	if (y > 0){
        	return 90;
        } else {
        	return 270;
        }
    }
    if (y == 0) {
    	if (x > 0){
        	return 0;
        } else {
        	return 180;
        }
    }

    if (x >= 0 & y >= 0){
        return radians_to_degrees(Math.atan(Math.abs(y) / Math.abs(x)));
    } else if (x <= 0 & y >= 0){
        return 180 - radians_to_degrees(Math.atan(Math.abs(y) / Math.abs(x)));
    } else if (x >= 0 & y <= 0){
        return 360 - radians_to_degrees(Math.atan(Math.abs(y) / Math.abs(x)));
    } else if (x <= 0 & y <= 0){
        return 180 + radians_to_degrees(Math.atan(Math.abs(y) / Math.abs(x)));
    }
}

function cmp(p1, p2, p3, p4, t){
    var x1 = p1[0];
    var y1 = p1[1];
    var x2 = p2[0];
    var y2 = p2[1];
    var x3 = p3[0];
    var y3 = p3[1];
    var x4 = p4[0];
    var y4 = p4[1];
    var deg1 = deg(x1, y1, x2, y2);
    var deg2 = deg(x3, y3, x4, y4);
    if (0 <= deg1 <= t || 360 - t <= deg1 <= 360){
        if (deg1 <= 100 & deg2 >= 300){
            deg2 = deg2 - 360;
        } else if (deg1 >= 300 & deg2 <= 100){
            deg2 = deg2 + 360;
        }
    }

    var val = (Math.max(0, t - Math.abs((deg2 - deg1)))) / t;
    return val;
}

function hands(ls1, e1, h1, ls2, e2, h2, t){
    return cmp(ls1, e1, ls2, e2, t) + cmp(e1, h1, e2, h2, t);
}

function shoulder(ls1, rs1, ls2, rs2, t){
    return cmp(ls1, rs1, ls2, rs2, t);
}

function leg(hp1, k1, l1, hp2, k2, l2, t){
    return cmp(hp1, k1, hp2, k2, t) + cmp(k1, l1, k2, l2, t);
}

function getHostData(hostList){
   var k = 0;
   res = [];
   for (k = 0; k < hostList.length; k++){
     var p = hostList[i]['pose']['keypoints'];
     var lst = [];
     datapts(p, lst);
     res.push(lst);
   }
   return res
}

function getScoreHost(host, client, t){
    var i;
    let res = 0;
    host = getHostData(host);
    for (i = 0; i < host.length; i++){
        res = Math.max(compare(host[i], client, t), res);
    }
    return res;
}

export default function getScore(json1, json2, t){
    var lst1 = [];
    var lst2 = [];
    var p1 = json1['pose']['keypoints'];
    var p2 = json2['pose']['keypoints'];
    datapts(p1, lst1);
    datapts(p2, lst2);
    return compare(lst1, lst2, t);
}

